RESET := \033[0m
BOLD := \033[1m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RED := \033[31m

all: build test

# Build per ambiente di sviluppo
build:
	@echo -e "\n${BOLD}${BLUE}ğŸ”¨ Building the application...${RESET}"
	@mkdir -p bin
	@go build -o ./bin/main cmd/api/main.go
	@echo -e "${GREEN}âœ… Build completed successfully!${RESET}\n"

# Build per la produzione (binario ottimizzato)
production:
	@echo -e "\n${BOLD}${BLUE}ğŸš€ Building for production...${RESET}"
	@mkdir -p bin
	@GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ./bin/main cmd/api/main.go
	@echo -e "${GREEN}âœ… Production build completed successfully!${RESET}\n"

# Run the application
run:
	@echo -e "\n${BOLD}${YELLOW}ğŸš€ Running the application...${RESET}"
	@go run cmd/api/main.go

# Test the application
test:
	@echo -e "\n${BOLD}${BLUE}ğŸ§ª Running tests...${RESET}"
	@go test ./... -v
	@echo -e "${GREEN}âœ… All tests completed!${RESET}\n"

# Integration Tests
itest:
	@echo -e "\n${BOLD}${BLUE}ğŸ” Running integration tests...${RESET}"
	@go test ./internal/database -v
	@echo -e "${GREEN}âœ… Integration tests completed!${RESET}\n"

# Clean the binary
clean:
	@echo -e "\n${BOLD}${YELLOW}ğŸ§¹ Cleaning up...${RESET}"
	@rm -rf ./bin/
	@echo -e "${GREEN}âœ… Cleanup complete!${RESET}\n"

# Live Reload (dev mode)
watch:
	@echo -e "\n${BOLD}${BLUE}ğŸ‘€ Starting live reload...${RESET}"
	@if command -v air > /dev/null; then \
		air; \
	else \
		read -p "Go's 'air' is not installed on your machine. Do you want to install it? [Y/n] " choice; \
		if [ "$$choice" != "n" ] && [ "$$choice" != "N" ]; then \
			echo "${YELLOW}Installing 'air'...${RESET}"; \
			go install github.com/air-verse/air@latest; \
			echo "${GREEN}âœ… 'air' installed successfully!${RESET}"; \
			air; \
		else \
			echo "${RED}âŒ You chose not to install 'air'. Exiting...${RESET}"; \
			exit 1; \
		fi; \
	fi

# Docker commands
# docker-build:
# 	@echo -e "\n${BOLD}${BLUE}ğŸ³ Building Docker image...${RESET}"
# 	@docker build -t hackthelove-backend .
# 	@echo -e "${GREEN}âœ… Docker image built successfully!${RESET}\n"

# docker-run:
# 	@echo -e "\n${BOLD}${BLUE}ğŸ³ Starting Docker containers...${RESET}"
# 	@if docker compose up --build 2>/dev/null; then \
# 		: ; \
# 	else \
# 		echo "${RED}âš ï¸  Falling back to Docker Compose V1...${RESET}"; \
# 		docker-compose up --build; \
# 	fi

# docker-down:
# 	@echo -e "\n${BOLD}${YELLOW}ğŸ“¦ Stopping Docker containers...${RESET}"
# 	@if docker compose down 2>/dev/null; then \
# 		: ; \
# 	else \
# 		echo "${RED}âš ï¸  Falling back to Docker Compose V1...${RESET}"; \
# 		docker-compose down; \
# 	fi

# docker-push:
# 	@echo -e "\n${BOLD}${BLUE}ğŸ“¤ Pushing Docker image to registry...${RESET}"
# 	@docker tag hackthelove-backend your-registry/hackthelove-backend:latest
# 	@docker push your-registry/hackthelove-backend:latest
# 	@echo -e "${GREEN}âœ… Docker image pushed successfully!${RESET}\n"

# Deployment command
# deploy:
# 	@echo -e "\n${BOLD}${BLUE}ğŸš€ Deploying to production...${RESET}"
# 	@ssh user@yourserver "cd /path/to/app && git pull && docker compose up --build -d"
# 	@echo -e "${GREEN}âœ… Deployment completed successfully!${RESET}\n"

help:
	@echo -e "\n${BOLD}${YELLOW}ğŸ“– Usage: make [target]${RESET}"
	@echo -e "\nTargets:"
	@echo -e "  ${BLUE}ğŸ”¨ build         ${RESET}Build the application"
	@echo -e "  ${YELLOW}ğŸš€ production    ${RESET}Build for production"
	@echo -e "  ${BLUE}ğŸ§ª test          ${RESET}Run tests"
	@echo -e "  ${YELLOW}ğŸ§¹ clean         ${RESET}Clean the binary"
	@echo -e "  ${BLUE}ğŸ‘€ watch         ${RESET}Live reload"
	@echo -e "  ${YELLOW}ğŸ³ docker-build  ${RESET}Build Docker image"
	@echo -e "  ${BLUE}ğŸ“¦ docker-run    ${RESET}Start Docker containers"
	@echo -e "  ${YELLOW}ğŸ“¦ docker-down   ${RESET}Stop Docker containers"
	@echo -e "  ${BLUE}ğŸ“¤ docker-push   ${RESET}Push Docker image"
	@echo -e "  ${YELLOW}ğŸš€ deploy        ${RESET}Deploy to production"
	@echo -e "  ${BLUE}ğŸ“– help          ${RESET}Display this help message"

.PHONY: all build production run test clean watch docker-build docker-run docker-down docker-push deploy
